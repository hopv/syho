--------------------------------------------------------------------------------
-- Prove the semantic soundness of the atomic, partial and total Hoare triples
--------------------------------------------------------------------------------

{-# OPTIONS --without-K --sized-types #-}

module Syho.Model.Hor.Sound where

open import Base.Size using (Size; Рѕъ; !)
open import Base.Func using (_$_; _Рќи_; _Рђ║_)
open import Base.Few using (absurd)
open import Base.Prod using (_,_; -,_; РѕЉ-case)
open import Base.Nat using (РёЋ)
open import Base.List using (List; []; _Рѕи_; rep)
open import Syho.Lang.Expr using (Addr; _Рѓњ_; Type; Val; TyVal)
open import Syho.Lang.Ktxred using (Redex; Val/Ktxred)
open import Syho.Lang.Reduce using (redр┤Й)
open import Syho.Logic.Prop using (PropРѕъ; _Рєд_; [РѕЌРѕѕРЂ▒РЪеРЪЕ]-syntax)
open import Syho.Logic.Core using (_┬╗_; РѕЃ-elim)
open import Syho.Logic.Hor using (_Ріб[_][_]рхЃРЪе_РЪЕ_; _Ріб[_]РЂ║РЪе_РЪЕр┤Й_; _Ріб[_]РЂ║РЪе_РЪЕрхђ[_]_;
  _Ріб[_][_]РЂ║РЪе_РЪЕРѕъ; hor-рхђРЄњр┤Й; ihorРЄњhorр┤Й; ahor-р╣А; horрхђ-р╣А; ihor-р╣А; _рхў┬╗рхЃ╩░_; _рхўр┤║┬╗╩░_;
  _рхўр┤║┬╗РЂ▒╩░_; _рхЃ╩░┬╗рхў_; _╩░┬╗рхўр┤║_; ahor-frame╦А; hor-frame╦А; ahorр┤║-hor; ahorр┤║-ihor;
  hor-bind; ihor-bind; hor-ihor-bind; hor-valрхўр┤║; ahor-nd; hor-[]; ihor-[]РЌІ;
  ihor-[]РЌЈ; hor-fork; ihor-fork)
open import Syho.Logic.Mem using (ahor-­Ъъ░; ahor-Рєљ; ahor-fau; ahor-cas-tt;
  ahor-cas-ff; ahor-alloc; ahor-free)
open import Syho.Logic.Ind using (РєфрхЃРЪеРЪЕ-use; РєфРЪеРЪЕр┤Й-use; РєфРЪеРЪЕрхђ-use; РєфРЪеРЪЕРѕъ-use)
open import Syho.Model.Prop.Base using (_Ріе_; [РѕЌрхњРѕѕРЂ▒РЪеРЪЕ]-syntax; РѕЌрхњ-mono; РѕЌрхњ-mono╦А;
  РѕЌрхњ-mono╩│; РѕЌрхњРѕЃрхњ-out; -РѕЌрхњ-intro╦А)
open import Syho.Model.Prop.Mem using (_Рєдрхњ_)
open import Syho.Model.Prop.Interp using (РИе_РИЕ)
open import Syho.Model.Prop.Sound using (Ріб-sem)
open import Syho.Model.Supd.Ind using (РєфрхЃРЪеРЪЕрхњ-use; РєфРЪеРЪЕрхњ-use; РєфРЪеРЪЕРѕърхњ-use)
open import Syho.Model.Supd.Interp using (РЄЏр┤хРЂ┐рхѕРЄњРЄЏрхњ; РЄЏрхњ-mono; РЄЏрхњ-eat╦А; РЄЏр┤║рхњ-mono)
open import Syho.Model.Supd.Sound using (РібРЄЏ-sem; РібРЄЏр┤║-sem)
open import Syho.Model.Hor.Wp using (рхЃРЪе_РЪЕрхњ; РЂ║РЪе_РЪЕр┤Йрхњ; РЂ║РЪе_РЪЕрхђрхњ; РЂ║РЪе_РЪЕРѕърхњ; РЂ║РЪеРЪЕр┤Йрхњ-val;
  РЂ║РЪеРЪЕрхђрхњ-val; РЂ║РЪеРЪЕр┤ЙрхњРЄњРЂ║РЪеРЪЕр┤ЙрхњРіц; РЂ║РЪеРЪЕрхђрхњРЄњРЂ║РЪеРЪЕрхђрхњРіц; рхЃРЪеРЪЕрхњ-mono; РЂ║РЪеРЪЕр┤Йрхњ-mono; РЂ║РЪеРЪЕрхђрхњ-mono;
  РіеРюЊРЄњРіе-рхЃРЪеРЪЕрхњ; РіеРюЊРЄњРіе-РЂ║РЪеРЪЕр┤Йрхњ; РіеРюЊРЄњРіе-РЂ║РЪеРЪЕрхђрхњ; РіеРюЊРЄњРіе-РЂ║РЪеРЪЕРѕърхњ; РЂ║РЪеРЪЕрхђрхњРЄњРЂ║РЪеРЪЕр┤Йрхњ; РЂ║РЪеРЪЕРѕърхњРЄњРЂ║РЪеРЪЕр┤Йрхњ;
  РЄЏрхњ-рхЃРЪеРЪЕрхњ; РЄЏр┤║рхњ-РЂ║РЪеРЪЕр┤Йрхњ; РЄЏрхњ-РЂ║РЪеРЪЕр┤Йрхњ; РЄЏр┤║рхњ-РЂ║РЪеРЪЕрхђрхњ; РЄЏрхњ-РЂ║РЪеРЪЕрхђрхњ; РЄЏр┤║рхњ-РЂ║РЪеРЪЕРѕърхњ; РЄЏрхњ-РЂ║РЪеРЪЕРѕърхњ;
  рхЃРЪеРЪЕрхњ-РЄЏрхњ; РЂ║РЪеРЪЕр┤Йрхњ-РЄЏр┤║рхњ; РЂ║РЪеРЪЕр┤Йрхњ-РЄЏрхњ; РЂ║РЪеРЪЕрхђрхњ-РЄЏр┤║рхњ; РЂ║РЪеРЪЕрхђрхњ-РЄЏрхњ; рхЃРЪеРЪЕрхњ-eat╦А; РЂ║РЪеРЪЕр┤Йрхњ-eat╦А;
  РЂ║РЪеРЪЕрхђрхњ-eat╦А)
open import Syho.Model.Hor.Lang using (рхЃРЪеРЪЕр┤║рхњ-РЪеРЪЕр┤Йрхњ; рхЃРЪеРЪЕр┤║рхњ-РЪеРЪЕрхђрхњ; рхЃРЪеРЪЕр┤║рхњ-РЪеРЪЕРѕърхњ;
  РЪеРЪЕр┤Йрхњ-bind; РЪеРЪЕрхђрхњ-bind; РЪеРЪЕРѕърхњ-bind; РЪеРЪЕрхђрхњ-РЪеРЪЕРѕърхњ-bind; рхЃРЪеРЪЕрхњ-nd; РЂ║РЪеРЪЕр┤Йрхњ-[]; РЂ║РЪеРЪЕрхђрхњ-[];
  РЂ║РЪеРЪЕРѕърхњ-[]РЌІ; РЂ║РЪеРЪЕРѕърхњ-[]РЌЈ; РЂ║РЪеРЪЕр┤Йрхњ-fork; РЂ║РЪеРЪЕрхђрхњ-fork; РЂ║РЪеРЪЕРѕърхњ-fork)
open import Syho.Model.Hor.Mem using (рхЃРЪеРЪЕрхњ-­Ъъ░; рхЃРЪеРЪЕрхњ-Рєљ; рхЃРЪеРЪЕрхњ-fau; рхЃРЪеРЪЕрхњ-cas-tt;
  рхЃРЪеРЪЕрхњ-cas-ff; рхЃРЪеРЪЕрхњ-alloc; рхЃРЪеРЪЕрхњ-free)

private variable
  ╬╣ :  Size
  X :  SetРѓђ
  T :  Type
  P :  PropРѕъ
  Q╦Ў :  X Рєњ  PropРѕъ
  red :  Redex T
  vk :  Val/Ktxred T
  i k :  РёЋ
  ╬И :  Addr
  рхЌvs :  List TyVal

--------------------------------------------------------------------------------
-- Lemmas on Рєдр┤И

abstract

  -- РИе ╬И Рєдр┤И рхЌvs РИЕ agrees with ╬И Рєдр┤Ирхњ рхЌvs
  -- For induction we use the unfolded versions with РѕѕРЂ▒РЪе k РЪЕ

  Рєдр┤ИРЄњРєдр┤Ирхњ :  РИе [РѕЌ (i , рхЌv) РѕѕРЂ▒РЪе k РЪЕ рхЌvs ] ╬И Рѓњ i Рєд рхЌv РИЕ  Ріе
            [РѕЌрхњ (i , рхЌv) РѕѕРЂ▒РЪе k РЪЕ рхЌvs ] ╬И Рѓњ i Рєдрхњ рхЌv
  Рєдр┤ИРЄњРєдр┤Ирхњ {рхЌvs = []} =  _
  Рєдр┤ИРЄњРєдр┤Ирхњ {рхЌvs = _ Рѕи рхЌvs'} =  РѕЌрхњ-mono╩│ $ Рєдр┤ИРЄњРєдр┤Ирхњ {рхЌvs = рхЌvs'}

  Рєдр┤ИрхњРЄњРєдр┤И :  [РѕЌрхњ (i , рхЌv) РѕѕРЂ▒РЪе k РЪЕ рхЌvs ] ╬И Рѓњ i Рєдрхњ рхЌv  Ріе
            РИе [РѕЌ (i , рхЌv) РѕѕРЂ▒РЪе k РЪЕ рхЌvs ] ╬И Рѓњ i Рєд рхЌv РИЕ
  Рєдр┤ИрхњРЄњРєдр┤И {рхЌvs = []} _ =  absurd
  Рєдр┤ИрхњРЄњРєдр┤И {рхЌvs = _ Рѕи рхЌvs'} =  РѕЌрхњ-mono╩│ $ Рєдр┤ИрхњРЄњРєдр┤И {рхЌvs = рхЌvs'}

--------------------------------------------------------------------------------
-- РібрхЃРЪеРЪЕ-sem :  Semantic soundness of the atomic Hoare triple

abstract

  РібрхЃРЪеРЪЕ-sem :  P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ  Q╦Ў  Рєњ   РИе P РИЕ  Ріе рхЃРЪе red РЪЕрхњ ╬╗ v Рєњ  РИе Q╦Ў v РИЕ

  -- _┬╗_ :  P Ріб[ Рѕъ ] Q Рєњ  Q Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ R╦Ў Рєњ  P Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ R╦Ў

  РібрхЃРЪеРЪЕ-sem (PРібQ ┬╗ QРібРЪеredРЪЕR) =  РіеРюЊРЄњРіе-рхЃРЪеРЪЕрхњ ╬╗ РюЊРѕЎ Рєњ Ріб-sem PРібQ РюЊРѕЎ Рђ║ РібрхЃРЪеРЪЕ-sem QРібРЪеredРЪЕR

  -- РѕЃ-elim :  (Рѕђ x Рєњ  P╦Ў x Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ Q╦Ў) Рєњ
  --           РѕЃ╦Ў P╦Ў Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ Q╦Ў

  РібрхЃРЪеРЪЕ-sem (РѕЃ-elim PxРібРЪеvkРЪЕQ) =   РѕЉ-case ╬╗ x Рєњ РібрхЃРЪеРЪЕ-sem (PxРібРЪеvkРЪЕQ x)

  -- ahor-р╣А :  P  Ріб[< Рѕъ ][ i ]рхЃРЪе red РЪЕ  Q╦Ў  Рєњ   P  Ріб[ Рѕъ ][ р╣А i ]рхЃРЪе red РЪЕ  Q╦Ў

  РібрхЃРЪеРЪЕ-sem (ahor-р╣А PРібРЪеredРЪЕQ) =  РібрхЃРЪеРЪЕ-sem (PРібРЪеredРЪЕQ .!)

  -- _рхў┬╗рхЃ╩░_ :  P  Ріб[ Рѕъ ][ j ]РЄЏ  Q  Рєњ   Q  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ  R╦Ў  Рєњ
  --           P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ  R╦Ў

  РібрхЃРЪеРЪЕ-sem (PРібРЄЏQ рхў┬╗рхЃ╩░ QРібРЪеredРЪЕR) =  РібРЄЏ-sem PРібРЄЏQ Рђ║
    РЄЏрхњ-mono (РібрхЃРЪеРЪЕ-sem QРібРЪеredРЪЕR) Рђ║ РЄЏрхњ-рхЃРЪеРЪЕрхњ

  -- _рхЃ╩░┬╗рхў_ :  P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ  Q╦Ў  Рєњ
  --           (Рѕђ v Рєњ  Q╦Ў v  Ріб[ Рѕъ ][ j ]РЄЏ  R╦Ў v)  Рєњ
  --           P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ  R╦Ў

  РібрхЃРЪеРЪЕ-sem (PРібРЪеredРЪЕQ рхЃ╩░┬╗рхў QvРібРЄЏRv) =  РібрхЃРЪеРЪЕ-sem PРібРЪеredРЪЕQ Рђ║
    рхЃРЪеРЪЕрхњ-mono (╬╗ v Qva Рєњ РібРЄЏ-sem (QvРібРЄЏRv v) Qva) Рђ║ рхЃРЪеРЪЕрхњ-РЄЏрхњ

  -- ahor-frame╦А :  P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ  Q╦Ў  Рєњ
  --                R  РѕЌ  P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ ╬╗ v Рєњ  R  РѕЌ  Q╦Ў v

  РібрхЃРЪеРЪЕ-sem (ahor-frame╦А PРібРЪеredРЪЕQ) =  РѕЌрхњ-mono╩│ (РібрхЃРЪеРЪЕ-sem PРібРЪеredРЪЕQ) Рђ║ рхЃРЪеРЪЕрхњ-eat╦А

  -- ahor-nd :  {{ Inh РИе X╩И РИЕ╩И }} Рєњ  P  Ріб[ Рѕъ ][ i ]рхЃРЪе ndр┤┐ {X╩И} РЪЕ ╬╗ _ Рєњ  P

  РібрхЃРЪеРЪЕ-sem ahor-nd =  рхЃРЪеРЪЕрхњ-nd

  -- ahor-­Ъъ░ :  ╬И РєдРЪе p РЪЕ (T , v)  Ріб[ Рѕъ ][ i ]рхЃРЪе ­Ъъ░р┤┐_ {T} ╬И РЪЕ ╬╗ u Рєњ
  --             Рїю u РЅА v РїЮРѕД  ╬И РєдРЪе p РЪЕ (T , v)

  РібрхЃРЪеРЪЕ-sem ahor-­Ъъ░ =  рхЃРЪеРЪЕрхњ-­Ъъ░

  -- ahor-Рєљ :  ╬И Рєд рхЌu  Ріб[ Рѕъ ][ i ]рхЃРЪе _Рєљр┤┐_ {T} ╬И v РЪЕ ╬╗ _ Рєњ  ╬И Рєд (T , v)

  РібрхЃРЪеРЪЕ-sem ahor-Рєљ =  рхЃРЪеРЪЕрхњ-Рєљ

  -- ahor-fau :  ╬И Рєд (РЌИ╩И X╩И , x)  Ріб[ Рѕъ ][ i ]рхЃРЪе fauр┤┐ f ╬И РЪЕ ╬╗ y Рєњ
  --               Рїю y РЅА x РїЮРѕД  ╬И Рєд (-, f x)

  РібрхЃРЪеРЪЕ-sem ahor-fau =  рхЃРЪеРЪЕрхњ-fau

  -- ahor-cas-tt :  ╬И Рєд (РЌИ╩И X╩И , x)  Ріб[ Рѕъ ][ i ]рхЃРЪе casр┤┐ ╬И x y РЪЕ ╬╗ b Рєњ
  --                  Рїю b РЅА tt РїЮРѕД  ╬И Рєд (-, y)

  РібрхЃРЪеРЪЕ-sem ahor-cas-tt =  рхЃРЪеРЪЕрхњ-cas-tt

  -- ahor-cas-ff :  z РЅб x  Рєњ
  --   ╬И РєдРЪе p РЪЕ (РЌИ╩И X╩И , z)  Ріб[ Рѕъ ][ i ]рхЃРЪе casр┤┐ ╬И x y РЪЕ ╬╗ b Рєњ
  --     Рїю b РЅА ff РїЮРѕД  ╬И РєдРЪе p РЪЕ (-, z)

  РібрхЃРЪеРЪЕ-sem (ahor-cas-ff zРЅбx) =  рхЃРЪеРЪЕрхњ-cas-ff zРЅбx

  -- ahor-alloc :  Ріц'  Ріб[ Рѕъ ][ i ]рхЃРЪе allocр┤┐ n РЪЕ ╬╗ ╬И Рєњ
  --                 ╬И Рєдр┤И rep n Ріц-  РѕЌ  Free n ╬И

  РібрхЃРЪеРЪЕ-sem (ahor-alloc {n = n}) _ =  рхЃРЪеРЪЕрхњ-alloc Рќи
    рхЃРЪеРЪЕрхњ-mono ╬╗ _ Рєњ РѕЌрхњ-mono╦А $ Рєдр┤ИрхњРЄњРєдр┤И {рхЌvs = rep n _}

  -- ahor-free :  len рхЌvs РЅА n  Рєњ
  --   ╬И Рєдр┤И рхЌvs  РѕЌ  Free n ╬И  Ріб[ Рѕъ ][ i ]рхЃРЪе freeр┤┐ ╬И РЪЕ ╬╗ _ Рєњ  Ріц'

  РібрхЃРЪеРЪЕ-sem (ahor-free {рхЌvs} lenvsРЅАn) =  РѕЌрхњ-mono╦А (Рєдр┤ИРЄњРєдр┤Ирхњ {рхЌvs = рхЌvs}) Рђ║
    рхЃРЪеРЪЕрхњ-free lenvsРЅАn Рђ║ рхЃРЪеРЪЕрхњ-mono ╬╗ _ _ Рєњ absurd

  -- РєфрхЃРЪеРЪЕ-use :  P╦ѓ .!  РѕЌ  (P╦ѓ Рєф[ i ]рхЃРЪе red РЪЕ Q╦ѓ╦Ў)
  --               Ріб[ Рѕъ ][ р╣А i ]рхЃРЪе red РЪЕ ╬╗ v Рєњ  Q╦ѓ╦Ў v .!
  -- The level increment р╣А i makes the recursive call of РібрхЃРЪеРЪЕ-sem inductive

  РібрхЃРЪеРЪЕ-sem РєфрхЃРЪеРЪЕ-use =  РѕЌрхњ-mono╩│ (РєфрхЃРЪеРЪЕрхњ-use Рђ║ РЄЏр┤хРЂ┐рхѕРЄњРЄЏрхњ) Рђ║ РЄЏрхњ-eat╦А Рђ║
    РЄЏрхњ-mono (РѕЌрхњРѕЃрхњ-out Рђ║ ╬╗ (-, big) Рєњ РѕЌрхњРѕЃрхњ-out big Рќи
    ╬╗ (PРѕЌRРібРЪеredРЪЕQ , PРѕЌRa) Рєњ РібрхЃРЪеРЪЕ-sem PРѕЌRРібРЪеredРЪЕQ PРѕЌRa) Рђ║ РЄЏрхњ-рхЃРЪеРЪЕрхњ

--------------------------------------------------------------------------------
-- РібРЂ║РЪеРЪЕрхђ-sem :  Semantic soundness of the total Hoare triple

abstract

  РібРЂ║РЪеРЪЕрхђ-sem :  P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ]  Q╦Ў  Рєњ
               РИе P РИЕ  Ріе РЂ║РЪе vk РЪЕрхђрхњ Рѕъ ╬╗ v Рєњ  РИе Q╦Ў v РИЕ

  -- _┬╗_ :  P Ріб[ Рѕъ ] Q Рєњ  Q Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ] R╦Ў Рєњ  P Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ] R╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (PРібQ ┬╗ QРібРЪеvkРЪЕR) =
    РіеРюЊРЄњРіе-РЂ║РЪеРЪЕрхђрхњ ╬╗ РюЊРѕЎ Рєњ Ріб-sem PРібQ РюЊРѕЎ Рђ║ РібРЂ║РЪеРЪЕрхђ-sem QРібРЪеvkРЪЕR

  -- РѕЃ-elim :  (Рѕђ x Рєњ  P╦Ў x Ріб[ Рѕъ ]РЪе vk РЪЕрхђ[ i ] Q╦Ў) Рєњ
  --           РѕЃ╦Ў P╦Ў Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ] Q╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (РѕЃ-elim PxРібРЪеvkРЪЕQ) =   РѕЉ-case ╬╗ x Рєњ РібРЂ║РЪеРЪЕрхђ-sem (PxРібРЪеvkРЪЕQ x)

  -- horрхђ-р╣А :  P  Ріб[< Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ]  Q╦Ў  Рєњ   P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ р╣А i ]  Q╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (horрхђ-р╣А PРібРЪеvkРЪЕQ) =  РібРЂ║РЪеРЪЕрхђ-sem (PРібРЪеvkРЪЕQ .!)

  -- _рхўр┤║┬╗╩░_ :  P  Ріб[ Рѕъ ][ i ]РЄЏр┤║  Q  Рєњ   Q  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ]  R╦Ў  Рєњ
  --           P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕ[ ╬║ ]  R╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (PРібРЄЏQ рхўр┤║┬╗╩░ QРібРЪеvkРЪЕR) =
    РібРЄЏр┤║-sem PРібРЄЏQ Рђ║ РЄЏр┤║рхњ-mono (РібРЂ║РЪеРЪЕрхђ-sem QРібРЪеvkРЪЕR) Рђ║ РЄЏр┤║рхњ-РЂ║РЪеРЪЕрхђрхњ

  -- _╩░┬╗рхўр┤║_ :  P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ]  Q╦Ў  Рєњ
  --           (Рѕђ v Рєњ  Q╦Ў v  Ріб[ Рѕъ ][ j ]РЄЏр┤║  R╦Ў v)  Рєњ
  --           P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ]  R╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (PРібРЪеvkРЪЕQ ╩░┬╗рхўр┤║ QvРібРЄЏRv) =
    РібРЂ║РЪеРЪЕрхђ-sem PРібРЪеvkРЪЕQ Рђ║ РЂ║РЪеРЪЕрхђрхњ-mono (╬╗ v Рєњ РібРЄЏр┤║-sem (QvРібРЄЏRv v)) Рђ║ РЂ║РЪеРЪЕрхђрхњ-РЄЏр┤║рхњ

  -- hor-frame╦А :  P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ]  Q╦Ў  Рєњ
  --               R  РѕЌ  P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ[ i ] ╬╗ v Рєњ  R  РѕЌ  Q╦Ў v

  РібРЂ║РЪеРЪЕрхђ-sem (hor-frame╦А PРібРЪеvkРЪЕQ) =  РѕЌрхњ-mono╩│ (РібРЂ║РЪеРЪЕрхђ-sem PРібРЪеvkРЪЕQ) Рђ║ РЂ║РЪеРЪЕрхђрхњ-eat╦А

  -- hor-valрхўр┤║ :  P  Ріб[ Рѕъ ][ i ]РЄЏр┤║  Q╦Ў v  Рєњ   P  Ріб[ Рѕъ ]РЂ║РЪе T / ─ЕРѓђ v РЪЕрхђ[ i ]  Q╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (hor-valрхўр┤║ PРібРЄЏQv) =  РібРЄЏр┤║-sem PРібРЄЏQv Рђ║ РЂ║РЪеРЪЕрхђрхњ-val

  -- ahorр┤║-hor :  [Ріц]р┤║ РѕЌ P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ (╬╗ v Рєњ  [Ріц]р┤║ РѕЌ Q╦Ў v)  Рєњ
  --              (Рѕђ v Рєњ  Q╦Ў v  Ріб[ Рѕъ ]РЪе K р┤иРЌЂ VРЄњE v РЪЕрхђ[ j ]  R╦Ў)  Рєњ
  --              P  Ріб[ Рѕъ ]РЂ║РЪе ─ЕРѓЂ (-, K , red) РЪЕрхђ[ j ]  R╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (ahorр┤║-hor PРібРЪеredРЪЕр┤║Q QvРібРЪеKvРЪЕR) =  -РѕЌрхњ-intro╦А (╬╗ _ Рєњ
    РібрхЃРЪеРЪЕ-sem PРібРЪеredРЪЕр┤║Q Рђ║ рхЃРЪеРЪЕрхњ-mono ╬╗ v Рєњ РѕЌрхњ-mono╩│ $ РібРЂ║РЪеРЪЕрхђ-sem (QvРібРЪеKvРЪЕR v)) Рђ║
    рхЃРЪеРЪЕр┤║рхњ-РЪеРЪЕрхђрхњ

  -- hor-bind :  P  Ріб[ Рѕъ ]РЪе e РЪЕрхђ[ i ]  Q╦Ў  Рєњ
  --             (Рѕђ v Рєњ  Q╦Ў v  Ріб[ Рѕъ ]РЪе K р┤иРЌЂ VРЄњE v РЪЕрхђ[ i ]  R╦Ў)  Рєњ
  --             P  Ріб[ Рѕъ ]РЪе K р┤иРЌЂ e РЪЕрхђ[ i ]  R╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (hor-bind PРібРЪеeРЪЕQ QvРібРЪеKvРЪЕR) =  РібРЂ║РЪеРЪЕрхђ-sem PРібРЪеeРЪЕQ Рђ║
    РЂ║РЪеРЪЕрхђрхњ-mono (╬╗ v Рєњ РібРЂ║РЪеРЪЕрхђ-sem (QvРібРЪеKvРЪЕR v)) Рђ║ РЪеРЪЕрхђрхњ-bind

  -- hor-[] :  P  Ріб[ Рѕъ ]РЪе K р┤иРЌЂ e РЪЕ[ ╬║ ]  Q╦Ў  Рєњ
  --           P  Ріб[ Рѕъ ]РЂ║РЪе ─ЕРѓЂ (-, K , [ e ]р┤┐РЪе b РЪЕ) РЪЕ[ ╬║ ]  Q╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (hor-[] PРібРЪеKeРЪЕQ) =  РібРЂ║РЪеРЪЕрхђ-sem PРібРЪеKeРЪЕQ Рђ║ РЂ║РЪеРЪЕрхђрхњ-[]

  -- hor-fork :  P  Ріб[ Рѕъ ]РЪе K р┤иРЌЂ РѕЄ _ РЪЕрхђ[ i ]  R╦Ў  Рєњ
  --             Q  Ріб[ Рѕъ ]РЪе e РЪЕрхђ[ i ] (╬╗ _ Рєњ  Ріц')  Рєњ
  --             P  РѕЌ  Q  Ріб[ Рѕъ ]РЂ║РЪе ─ЕРѓЂ (-, K , forkр┤┐ e) РЪЕрхђ[ i ]  R╦Ў

  РібРЂ║РЪеРЪЕрхђ-sem (hor-fork PРібРЪеKРЪЕR QРібРЪеeРЪЕ) =
    РѕЌрхњ-mono (РібРЂ║РЪеРЪЕрхђ-sem PРібРЪеKРЪЕR) (РібРЂ║РЪеРЪЕрхђ-sem QРібРЪеeРЪЕ Рђ║ РЂ║РЪеРЪЕрхђрхњРЄњРЂ║РЪеРЪЕрхђрхњРіц) Рђ║ РЂ║РЪеРЪЕрхђрхњ-fork

  -- РєфРЪеРЪЕрхђ-use :  P╦ѓ .! РѕЌ (P╦ѓ РєфРЪе e РЪЕрхђ[ i ] Q╦ѓ╦Ў)
  --               Ріб[ Рѕъ ]РЪе e РЪЕрхђ[ р╣А i ] ╬╗ v Рєњ  Q╦ѓ╦Ў v .!
  -- The level increment р╣А i makes the recursive call of РібРЂ║РЪеРЪЕрхђ-sem inductive

  РібРЂ║РЪеРЪЕрхђ-sem РєфРЪеРЪЕрхђ-use =  РѕЌрхњ-mono╩│ (РєфРЪеРЪЕрхњ-use Рђ║ РЄЏр┤хРЂ┐рхѕРЄњРЄЏрхњ) Рђ║ РЄЏрхњ-eat╦А Рђ║
    (РЄЏрхњ-mono $ РѕЌрхњРѕЃрхњ-out Рђ║ ╬╗ (-, big) Рєњ РѕЌрхњРѕЃрхњ-out big Рќи
    ╬╗ (PРѕЌRРібРЪеeРЪЕQ , PРѕЌRa) Рєњ РібРЂ║РЪеРЪЕрхђ-sem PРѕЌRРібРЪеeРЪЕQ PРѕЌRa) Рђ║ РЄЏрхњ-РЂ║РЪеРЪЕрхђрхњ

--------------------------------------------------------------------------------
-- РібРЂ║РЪеРЪЕРѕъ-sem :  Semantic soundness of the infinite Hoare triple

abstract

  РібРЂ║РЪеРЪЕРѕъ-sem :  P  Ріб[ Рѕъ ][ i ]РЂ║РЪе vk РЪЕРѕъ  Рєњ   РИе P РИЕ  Ріе РЂ║РЪе vk РЪЕРѕърхњ Рѕъ ╬╣

  -- The metric of termination is the triple of the level i, the size ╬╣, and the
  -- structure of the proof Ріб[ ][ ]РЂ║РЪе РЪЕРѕъ
  -- For the rule ihor-[]РЌЈ, the proof structure does not decrease but the size ╬╣
  -- does, which is the key trick (see also РібРЂ║РЪеРЪЕр┤Й-sem)

  -- _┬╗_ :  P Ріб[ Рѕъ ] Q Рєњ  Q Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕРѕъ Рєњ  P Ріб[ Рѕъ ][ i ]РЂ║РЪе vk РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (PРібQ ┬╗ QРібРЪеvkРЪЕРѕъ) =
    РіеРюЊРЄњРіе-РЂ║РЪеРЪЕРѕърхњ ╬╗ РюЊРѕЎ Рєњ Ріб-sem PРібQ РюЊРѕЎ Рђ║ РібРЂ║РЪеРЪЕРѕъ-sem QРібРЪеvkРЪЕРѕъ

  -- РѕЃ-elim :  (Рѕђ x Рєњ  P╦Ў x Ріб[ Рѕъ ][ i ]РЂ║РЪе vk РЪЕРѕъ) Рєњ  РѕЃ╦Ў P╦Ў Ріб[ Рѕъ ][ i ]РЂ║РЪе vk РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (РѕЃ-elim PxРібРЪеvkРЪЕРѕъ) =   РѕЉ-case ╬╗ x Рєњ РібРЂ║РЪеРЪЕРѕъ-sem (PxРібРЪеvkРЪЕРѕъ x)

  -- ihor-р╣А :  P  Ріб[< Рѕъ ][ i ]РЂ║РЪе vk РЪЕРѕъ  Рєњ   P  Ріб[ Рѕъ ][ р╣А i ]РЂ║РЪе vk РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (ihor-р╣А PРібРЪеvkРЪЕРѕъ) =  РібРЂ║РЪеРЪЕРѕъ-sem (PРібРЪеvkРЪЕРѕъ .!)

  -- _рхўр┤║┬╗РЂ▒╩░_ :  P  Ріб[ Рѕъ ][ i ]РЄЏр┤║  Q  Рєњ   Q  Ріб[ Рѕъ ][ j ]РЂ║РЪе vk РЪЕРѕъ  Рєњ
  --            P  Ріб[ Рѕъ ][ j ]РЂ║РЪе vk РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (PРібРЄЏQ рхўр┤║┬╗РЂ▒╩░ QРібРЪеvkРЪЕРѕъ) =
    РібРЄЏр┤║-sem PРібРЄЏQ Рђ║ РЄЏр┤║рхњ-mono (РібРЂ║РЪеРЪЕРѕъ-sem QРібРЪеvkРЪЕРѕъ) Рђ║ РЄЏр┤║рхњ-РЂ║РЪеРЪЕРѕърхњ

  -- ahorр┤║-ihor :  [Ріц]р┤║ РѕЌ P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ (╬╗ v Рєњ  [Ріц]р┤║ РѕЌ Q╦Ў v)  Рєњ
  --               (Рѕђ v Рєњ  Q╦Ў v  Ріб[ Рѕъ ][ j ]РЪе K р┤иРЌЂ VРЄњE v РЪЕРѕъ)  Рєњ
  --               P  Ріб[ Рѕъ ][ j ]РЂ║РЪе ─ЕРѓЂ (-, K , red) РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (ahorр┤║-ihor PРібРЪеredРЪЕр┤║Q QvРібРЪеKvРЪЕРѕъ) =  -РѕЌрхњ-intro╦А (╬╗ _ Рєњ
    РібрхЃРЪеРЪЕ-sem PРібРЪеredРЪЕр┤║Q Рђ║ рхЃРЪеРЪЕрхњ-mono ╬╗ v Рєњ РѕЌрхњ-mono╩│ $ РібРЂ║РЪеРЪЕРѕъ-sem (QvРібРЪеKvРЪЕРѕъ v)) Рђ║
    рхЃРЪеРЪЕр┤║рхњ-РЪеРЪЕРѕърхњ

  -- ihor-bind :  P  Ріб[ Рѕъ ][ i ]РЪе e РЪЕРѕъ  Рєњ   P  Ріб[ Рѕъ ][ i ]РЪе K р┤иРЌЂ e РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (ihor-bind PРібРЪеeРЪЕРѕъ) =  РібРЂ║РЪеРЪЕРѕъ-sem PРібРЪеeРЪЕРѕъ Рђ║ РЪеРЪЕРѕърхњ-bind

  -- hor-ihor-bind :  P  Ріб[ Рѕъ ]РЪе e РЪЕрхђ[ i ] Q╦Ў  Рєњ
  --                  (Рѕђ v Рєњ  Q╦Ў v  Ріб[ Рѕъ ][ j ]РЪе K р┤иРЌЂ VРЄњE v РЪЕРѕъ)  Рєњ
  --                  P  Ріб[ Рѕъ ][ j ]РЪе K р┤иРЌЂ e РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (hor-ihor-bind PРібРЪеeРЪЕQ QvРібРЪеKvРЪЕРѕъ) =  РібРЂ║РЪеРЪЕрхђ-sem PРібРЪеeРЪЕQ Рђ║
    РЂ║РЪеРЪЕрхђрхњ-mono (╬╗ v Рєњ РібРЂ║РЪеРЪЕРѕъ-sem (QvРібРЪеKvРЪЕРѕъ v)) Рђ║ РЪеРЪЕрхђрхњ-РЪеРЪЕРѕърхњ-bind

  -- ihor-[]РЌІ :  P  Ріб[ Рѕъ ][ i ]РЪе K р┤иРЌЂ e РЪЕРѕъ  Рєњ
  --             P  Ріб[ Рѕъ ][ i ]РЂ║РЪе ─ЕРѓЂ (-, K , [ e ]р┤┐РЌІ) РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (ihor-[]РЌІ PРібРЪеKeРЪЕРѕъ) =  РібРЂ║РЪеРЪЕРѕъ-sem PРібРЪеKeРЪЕРѕъ Рђ║ РЂ║РЪеРЪЕРѕърхњ-[]РЌІ

  -- ihor-[]РЌЈ :  P  Ріб[< Рѕъ ][ i ]РЪе K р┤иРЌЂ e РЪЕРѕъ  Рєњ
  --             P  Ріб[ Рѕъ ][ i ]РЂ║РЪе ─ЕРѓЂ (-, K , [ e ]р┤┐РЌЈ) РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (ihor-[]РЌЈ PРібРЪеKeРЪЕРѕъ) Pa =
    РЂ║РЪеРЪЕРѕърхњ-[]РЌЈ ╬╗{ .! Рєњ РібРЂ║РЪеРЪЕРѕъ-sem (PРібРЪеKeРЪЕРѕъ .!) Pa }

  -- ihor-fork :  P  Ріб[ Рѕъ ][ i ]РЪе K р┤иРЌЂ РѕЄ _ РЪЕРѕъ  Рєњ
  --              Q  Ріб[ Рѕъ ]РЪе e РЪЕрхђ[ j ] (╬╗ _ Рєњ  Ріц')  Рєњ
  --              P  РѕЌ  Q  Ріб[ Рѕъ ][ i ]РЂ║РЪе ─ЕРѓЂ (-, K , forkр┤┐ e) РЪЕРѕъ

  РібРЂ║РЪеРЪЕРѕъ-sem (ihor-fork PРібРЪеKРЪЕРѕъ QРібРЪеeРЪЕ) =
    РѕЌрхњ-mono (РібРЂ║РЪеРЪЕРѕъ-sem PРібРЪеKРЪЕРѕъ) (РібРЂ║РЪеРЪЕрхђ-sem QРібРЪеeРЪЕ Рђ║ РЂ║РЪеРЪЕрхђрхњРЄњРЂ║РЪеРЪЕрхђрхњРіц) Рђ║ РЂ║РЪеРЪЕРѕърхњ-fork

  -- РєфРЪеРЪЕРѕъ-use :  P╦ѓ .!  РѕЌ  (P╦ѓ Рєф[ i ]РЪе e РЪЕРѕъ)  Ріб[ Рѕъ ][ р╣А i ]РЪе e РЪЕРѕъ
  -- The level increment р╣А i makes the recursive call of РібРЂ║РЪеРЪЕРѕъ-sem inductive
  -- (just like РєфРЪеРЪЕрхђ-use)

  РібРЂ║РЪеРЪЕРѕъ-sem РєфРЪеРЪЕРѕъ-use =  РѕЌрхњ-mono╩│ (РєфРЪеРЪЕРѕърхњ-use Рђ║ РЄЏр┤хРЂ┐рхѕРЄњРЄЏрхњ) Рђ║ РЄЏрхњ-eat╦А Рђ║
    (РЄЏрхњ-mono $ РѕЌрхњРѕЃрхњ-out Рђ║ ╬╗ (-, big) Рєњ РѕЌрхњРѕЃрхњ-out big Рќи
    ╬╗ (PРѕЌRРібРЪеeРЪЕQ , PРѕЌRa) Рєњ РібРЂ║РЪеРЪЕРѕъ-sem PРѕЌRРібРЪеeРЪЕQ PРѕЌRa) Рђ║ РЄЏрхњ-РЂ║РЪеРЪЕРѕърхњ

--------------------------------------------------------------------------------
-- РібРЂ║РЪеРЪЕр┤Й-sem :  Semantic soundness of the partial Hoare triple

abstract

  РібРЂ║РЪеРЪЕр┤Й-sem : P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й  Q╦Ў  Рєњ   РИе P РИЕ  Ріе РЂ║РЪе vk РЪЕр┤Йрхњ ╬╣ ╬╗ v Рєњ  РИе Q╦Ў v РИЕ

  -- The metric of termination is the pair of the size ╬╣ and the structure of
  -- the proof Ріб[ ]РЂ║РЪе РЪЕр┤Й
  -- For rules like РєфРЪеРЪЕр┤Й-use and horр┤Й-[], the proof structure does not decrease
  -- but the size ╬╣ does, which is the key trick

  -- _┬╗_ :  P Ріб[ Рѕъ ] Q Рєњ  Q Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й R╦Ў Рєњ  P Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й R╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (PРібQ ┬╗ QРібРЪеvkРЪЕR) =
    РіеРюЊРЄњРіе-РЂ║РЪеРЪЕр┤Йрхњ ╬╗ РюЊРѕЎ Рєњ Ріб-sem PРібQ РюЊРѕЎ Рђ║ РібРЂ║РЪеРЪЕр┤Й-sem QРібРЪеvkРЪЕR

  -- РѕЃ-elim :  (Рѕђ x Рєњ  P╦Ў x Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й Q╦Ў) Рєњ  РѕЃ╦Ў P╦Ў Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й Q╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (РѕЃ-elim PxРібРЪеvkРЪЕQ) =   РѕЉ-case ╬╗ x Рєњ РібРЂ║РЪеРЪЕр┤Й-sem (PxРібРЪеvkРЪЕQ x)

  -- _рхўр┤║┬╗╩░_ :  P  Ріб[ Рѕъ ][ i ]РЄЏр┤║  Q  Рєњ   Q  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й  R╦Ў  Рєњ
  --           P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й  R╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (PРібРЄЏQ рхўр┤║┬╗╩░ QРібРЪеvkРЪЕR) =
    РібРЄЏр┤║-sem PРібРЄЏQ Рђ║ РЄЏр┤║рхњ-mono (РібРЂ║РЪеРЪЕр┤Й-sem QРібРЪеvkРЪЕR) Рђ║ РЄЏр┤║рхњ-РЂ║РЪеРЪЕр┤Йрхњ

  -- _╩░┬╗рхўр┤║_ :  P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й  Q╦Ў  Рєњ   (Рѕђ v Рєњ  Q╦Ў v  Ріб[ Рѕъ ][ j ]РЄЏр┤║  R╦Ў v)  Рєњ
  --           P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й  R╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (PРібРЪеvkРЪЕQ ╩░┬╗рхўр┤║ QvРібРЄЏRv) =
    РібРЂ║РЪеРЪЕр┤Й-sem PРібРЪеvkРЪЕQ Рђ║ РЂ║РЪеРЪЕр┤Йрхњ-mono (╬╗ v Рєњ РібРЄЏр┤║-sem (QvРібРЄЏRv v)) Рђ║ РЂ║РЪеРЪЕр┤Йрхњ-РЄЏр┤║рхњ

  -- hor-рхђРЄњр┤Й :  P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕрхђ  Q╦Ў  Рєњ   P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й  Q╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (hor-рхђРЄњр┤Й PРібРЪеvkРЪЕQ) =  РібРЂ║РЪеРЪЕрхђ-sem PРібРЪеvkРЪЕQ Рђ║ РЂ║РЪеРЪЕрхђрхњРЄњРЂ║РЪеРЪЕр┤Йрхњ

  -- ihorРЄњhorр┤Й :  P  Ріб[ Рѕъ ][ i ]РЂ║РЪе vk РЪЕРѕъ  Рєњ   P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й  Q╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (ihorРЄњhorр┤Й PРібРЪеvkРЪЕРѕъ) =  РібРЂ║РЪеРЪЕРѕъ-sem PРібРЪеvkРЪЕРѕъ Рђ║ РЂ║РЪеРЪЕРѕърхњРЄњРЂ║РЪеРЪЕр┤Йрхњ

  -- hor-frame╦А :  P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й  Q╦Ў  Рєњ
  --               R  РѕЌ  P  Ріб[ Рѕъ ]РЂ║РЪе vk РЪЕр┤Й ╬╗ v Рєњ  R  РѕЌ  Q╦Ў v

  РібРЂ║РЪеРЪЕр┤Й-sem (hor-frame╦А PРібРЪеvkРЪЕQ) =  РѕЌрхњ-mono╩│ (РібРЂ║РЪеРЪЕр┤Й-sem PРібРЪеvkРЪЕQ) Рђ║ РЂ║РЪеРЪЕр┤Йрхњ-eat╦А

  -- hor-valрхўр┤║ :  P  Ріб[ Рѕъ ][ i ]РЄЏр┤║  Q╦Ў v  Рєњ   P  Ріб[ Рѕъ ]РЂ║РЪе T / ─ЕРѓђ v РЪЕр┤Й  Q╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (hor-valрхўр┤║ PРібРЄЏQv) =  РібРЄЏр┤║-sem PРібРЄЏQv Рђ║ РЂ║РЪеРЪЕр┤Йрхњ-val

  -- ahorр┤║-hor :  [Ріц]р┤║ РѕЌ P  Ріб[ Рѕъ ][ i ]рхЃРЪе red РЪЕ (╬╗ v Рєњ  [Ріц]р┤║ РѕЌ  v)  Рєњ
  --              (Рѕђ v Рєњ  Q╦Ў v  Ріб[< Рѕъ ]РЪе K р┤иРЌЂ VРЄњE v РЪЕр┤Й  R╦Ў)  Рєњ
  --              P  Ріб[ Рѕъ ]РЂ║РЪе ─ЕРѓЂ (-, K , red) РЪЕр┤Й  R╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (ahorр┤║-hor PРібРЪеredРЪЕр┤║Q QvРібРЪеKvРЪЕR) =  -РѕЌрхњ-intro╦А (╬╗ _ Рєњ
    РібрхЃРЪеРЪЕ-sem PРібРЪеredРЪЕр┤║Q Рђ║ рхЃРЪеРЪЕрхњ-mono ╬╗ v Рєњ РѕЌрхњ-mono╩│ ╬╗ big Рєњ
    ╬╗{ .! Рєњ big Рќи РібРЂ║РЪеРЪЕр┤Й-sem (QvРібРЪеKvРЪЕR v .!) }) Рђ║ рхЃРЪеРЪЕр┤║рхњ-РЪеРЪЕр┤Йрхњ

  -- hor-bind :  P  Ріб[ Рѕъ ]РЪе e РЪЕр┤Й  Q╦Ў  Рєњ
  --             (Рѕђ v Рєњ  Q╦Ў v  Ріб[ Рѕъ ]РЪе K р┤иРЌЂ VРЄњE v РЪЕр┤Й  R╦Ў)  Рєњ
  --             P  Ріб[ Рѕъ ]РЪе K р┤иРЌЂ e РЪЕр┤Й  R╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (hor-bind PРібРЪеeРЪЕQ QvРібРЪеKvРЪЕR) =  РібРЂ║РЪеРЪЕр┤Й-sem PРібРЪеeРЪЕQ Рђ║
    РЂ║РЪеРЪЕр┤Йрхњ-mono (╬╗ v Рєњ РібРЂ║РЪеРЪЕр┤Й-sem (QvРібРЪеKvРЪЕR v)) Рђ║ РЪеРЪЕр┤Йрхњ-bind

  -- hor-[] :  P  Ріб[< Рѕъ ]РЪе K р┤иРЌЂ e РЪЕр┤Й  Q╦Ў  Рєњ
  --           P  Ріб[ Рѕъ ]РЂ║РЪе ─ЕРѓЂ (-, K , [ e ]р┤┐РЪе b РЪЕ) РЪЕр┤Й  Q╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (hor-[] PРібРЪеKeРЪЕQ) Pa =  РЂ║РЪеРЪЕр┤Йрхњ-[] ╬╗{ .! Рєњ РібРЂ║РЪеРЪЕр┤Й-sem (PРібРЪеKeРЪЕQ .!) Pa }

  -- hor-fork :  P  Ріб[< Рѕъ ]РЪе K р┤иРЌЂ РѕЄ _ РЪЕр┤Й  R╦Ў  Рєњ
  --             Q  Ріб[< Рѕъ ]РЪе e РЪЕр┤Й (╬╗ _ Рєњ  Ріц')  Рєњ
  --             P  РѕЌ  Q  Ріб[ Рѕъ ]РЂ║РЪе ─ЕРѓЂ (-, K , forkр┤┐ e) РЪЕр┤Й  R╦Ў

  РібРЂ║РЪеРЪЕр┤Й-sem (hor-fork PРібРЪеKРЪЕR QРібРЪеeРЪЕ) =  РѕЌрхњ-mono
    (╬╗ Pb Рєњ ╬╗{ .! Рєњ Pb Рќи РібРЂ║РЪеРЪЕр┤Й-sem (PРібРЪеKРЪЕR .!) })
    (╬╗ Qc Рєњ ╬╗{ .! Рєњ Qc Рќи РібРЂ║РЪеРЪЕр┤Й-sem (QРібРЪеeРЪЕ .!) Рќи РЂ║РЪеРЪЕр┤ЙрхњРЄњРЂ║РЪеРЪЕр┤ЙрхњРіц }) Рђ║ РЂ║РЪеРЪЕр┤Йрхњ-fork

  -- РєфРЪеРЪЕр┤Й-use :  e РЄњр┤Й e'  Рєњ
  --   P╦ѓ .!  РѕЌ  (P╦ѓ РєфРЪе e' РЪЕр┤Й Q╦ѓ╦Ў)  Ріб[ Рѕъ ]РЪе e РЪЕр┤Й ╬╗ v Рєњ  Q╦ѓ╦Ў v .!

  РібРЂ║РЪеРЪЕр┤Й-sem (РєфРЪеРЪЕр┤Й-use (-, redр┤Й eРЄњK[eРѓђ])) big  rewrite eРЄњK[eРѓђ] =
    РЂ║РЪеРЪЕр┤Йрхњ-[] ╬╗{ .! Рєњ big Рќи РѕЌрхњ-mono╩│ (РєфРЪеРЪЕрхњ-use Рђ║ РЄЏр┤хРЂ┐рхѕРЄњРЄЏрхњ) Рќи РЄЏрхњ-eat╦А Рќи
    (РЄЏрхњ-mono $ РѕЌрхњРѕЃрхњ-out Рђ║ ╬╗ (-, big) Рєњ РѕЌрхњРѕЃрхњ-out big Рќи
    ╬╗ (PРѕЌRРібРЪеeРЪЕQ , PРѕЌRa) Рєњ РібРЂ║РЪеРЪЕр┤Й-sem PРѕЌRРібРЪеeРЪЕQ PРѕЌRa) Рќи РЄЏрхњ-РЂ║РЪеРЪЕр┤Йрхњ }
