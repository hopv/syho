--------------------------------------------------------------------------------
-- Semantic super update and weakest precondition lemmas for the memory
--------------------------------------------------------------------------------

{-# OPTIONS --sized-types #-}

module Syho.Model.Hor.Mem where

open import Base.Level using (Level)
open import Base.Func using (_$_; _Рќи_; _Рђ║_)
open import Base.Eq using (_РЅА_; refl; РЌа_; _РЌЄ_; cong)
open import Base.Size using (Size; Рѕъ; !; ┬Д_)
open import Base.Prod using (¤ђРѓЂ; _,_; -,_)
open import Base.Sum using (─ЕРѓЂ_)
open import Base.Option using (┼А_; ┼ѕ)
open import Base.Dec using (upd╦Ў)
open import Base.Nat using (РёЋ)
open import Base.List using (List; len; rep)
open import Base.RatPos using (РёџРЂ║)
open import Syho.Lang.Expr using (Addr; addr; Type; РѕЄ_; Val; VРЄњE; TyVal; Ріцр╣й)
open import Syho.Lang.Ktxred using (Ktx; _р┤иРЌЂ_; ­Ъъ░р┤┐_; _Рєљр┤┐_; allocр┤┐; freeр┤┐; _р┤и|_)
open import Syho.Lang.Reduce using (Mem; _Рђ╝р┤╣_; updр┤╣; ­Ъъ░РЄњ; РєљРЄњ; allocРЄњ; freeРЄњ;
  redр┤ир┤┐)
open import Syho.Model.ERA.Glob using (upd╦Ў-mem-envр┤│)
open import Syho.Model.ERA.Mem using (╬хр┤╣рхЅрхљ; РєдРЪеРЪЕ╩│-read; Рєд╩│-write; Рєдр┤И╩│-alloc;
  Рєдр┤И╩│-free)
open import Syho.Model.Prop.Base using (Propрхњ; _Ріе_; Ріе_; Рїю_РїЮрхњ├Ќ_; РіцрхњРѓђ; _РѕЌрхњ_;
  _РцЄр┤▒_; РѕЌрхњ-mono╦А; РѕЃрхњРѕЌрхњ-out; РцЄр┤▒-mono; РцЄр┤▒-respр┤▒╩│; РцЄр┤▒-param; РЌјРЪеРЪЕ-РѕЌрхњРЄњРѕЎ; РЌјРЪеРЪЕ-РѕЎРЄњРѕЌрхњ;
  РєЮ-РЌјРЪеРЪЕ-РцЄр┤▒; ╬хРєЮ-РЌјРЪеРЪЕ-РцЄр┤▒)
open import Syho.Model.Prop.Mem using (_РєдРЪе_РЪЕрхњ_; _Рєдрхњ_; Freeрхњ'; Freeрхњ; _Рєдр┤Ирхњ_;
  _Рєдр┤Ирхњ'_; Рєдр┤ИрхњРЄњРєдр┤Ирхњ'; Рєдр┤Ирхњ'РЄњРєдр┤Ирхњ)
open import Syho.Model.Supd.Interp using (РЪе_РЪЕРЄЏрхњРЪе_РЪЕ_; РЄЏрхњ-mono; ?РіеРцЄр┤▒р┤╣рхЅрхљРЄњ?РіеРЄЏрхњ;
  РіеРцЄр┤▒р┤╣рхЅрхљРЄњРіеРЄЏрхњ; РЄЏрхњ-intro; РЄЏрхњ-eat╩│)
open import Syho.Model.Hor.Wp using (РЂ║РЪе_РЪЕр┤Йрхњ[_]_; РЂ║РЪе_РЪЕрхђрхњ[_]_; РЪе_РЪЕр┤Йрхњ[_]_;
  РЪе_РЪЕрхђрхњ[_]_; РЂ║РЪеРЪЕр┤Йрхњ-kr; РЂ║РЪеРЪЕрхђрхњ-kr)

private variable
  ┼ѓ :  Level
  ╬╣ :  Size
  T U :  Type
  Pрхњ Qрхњ :  Propрхњ ┼ѓ
  Qрхњ╦Ў :  Val T Рєњ Propрхњ ┼ѓ
  M M' :  Mem
  ╬И :  Addr
  p :  РёџРЂ║
  o n :  РёЋ
  рхЌu рхЌv :  TyVal
  рхЌvs :  List TyVal
  K :  Ktx T U
  u v :  Val T

--------------------------------------------------------------------------------
-- Semantic super update for the memory

abstract

  -- Read using РєдРЪеРЪЕрхњ

  РєдРЪеРЪЕрхњ-read :  ╬И РєдРЪе p РЪЕрхњ рхЌv  Ріе  РЪе M РЪЕРЄЏрхњРЪе M РЪЕ
                Рїю M Рђ╝р┤╣ ╬И РЅА ┼А рхЌv РїЮрхњ├Ќ  ╬И РєдРЪе p РЪЕрхњ рхЌv
  РєдРЪеРЪЕрхњ-read =  ?РіеРцЄр┤▒р┤╣рхЅрхљРЄњ?РіеРЄЏрхњ $ РєЮ-РЌјРЪеРЪЕ-РцЄр┤▒ РєдРЪеРЪЕ╩│-read Рђ║ РцЄр┤▒-respр┤▒╩│ upd╦Ў-mem-envр┤│ Рђ║
    РцЄр┤▒-mono (╬╗ MРђ╝╬ИРЅАv Рєњ  MРђ╝╬ИРЅАv ,_) Рђ║ РцЄр┤▒-param

  -- Write using Рєдрхњ

  Рєдрхњ-write :  ╬И Рєдрхњ рхЌu  Ріе  РЪе M РЪЕРЄЏрхњРЪе updр┤╣ ╬И рхЌv M РЪЕ  ╬И Рєдрхњ рхЌv
  Рєдрхњ-write =  ?РіеРцЄр┤▒р┤╣рхЅрхљРЄњ?РіеРЄЏрхњ $ РєЮ-РЌјРЪеРЪЕ-РцЄр┤▒ Рєд╩│-write Рђ║ РцЄр┤▒-respр┤▒╩│ upd╦Ў-mem-envр┤│

  -- Allocate getting Рєдр┤Ирхњ' and Freeрхњ'

  Рєдр┤Ирхњ'-alloc :  M o РЅА ┼ѕ  Рєњ
    Ріе  РЪе M РЪЕРЄЏрхњРЪе upd╦Ў o (┼А rep n Ріцр╣й) M РЪЕ  o Рєдр┤Ирхњ' rep n Ріцр╣й  РѕЌрхњ  Freeрхњ' n o
  Рєдр┤Ирхњ'-alloc MoРЅА┼ѕ =  РіеРцЄр┤▒р┤╣рхЅрхљРЄњРіеРЄЏрхњ (╬хРєЮ-РЌјРЪеРЪЕ-РцЄр┤▒ (Рєдр┤И╩│-alloc MoРЅА┼ѕ) Рќи
    РцЄр┤▒-respр┤▒╩│ upd╦Ў-mem-envр┤│ Рќи РцЄр┤▒-mono ╬╗ _ Рєњ РЌјРЪеРЪЕ-РѕЎРЄњРѕЌрхњ)

  -- Free using Рєдр┤Ирхњ' and Freeрхњ'

  Рєдр┤Ирхњ'-free :  len рхЌvs РЅА n  Рєњ
    o Рєдр┤Ирхњ' рхЌvs  РѕЌрхњ  Freeрхњ' n o  Ріе  РЪе M РЪЕРЄЏрхњРЪе upd╦Ў o ┼ѕ M РЪЕ  РіцрхњРѓђ
  Рєдр┤Ирхњ'-free lenvsРЅАn =  ?РіеРцЄр┤▒р┤╣рхЅрхљРЄњ?РіеРЄЏрхњ $ РЌјРЪеРЪЕ-РѕЌрхњРЄњРѕЎ Рђ║
    РєЮ-РЌјРЪеРЪЕ-РцЄр┤▒ {bРЂ▒╦Ў = ╬╗ _ Рєњ ╬хр┤╣рхЅрхљ} (Рєдр┤И╩│-free lenvsРЅАn) Рђ║ РцЄр┤▒-respр┤▒╩│ upd╦Ў-mem-envр┤│ Рђ║
    РцЄр┤▒-mono _

--------------------------------------------------------------------------------
-- Weakest precondition lemmas for the memory

abstract

  -- ­Ъъ░ and РЂ║РЪеРЪЕр┤Йрхњ / РЂ║РЪеРЪЕрхђрхњ
  ---- We need the axiom K to get v РЅА v' out of MРђ╝╬ИРЅАv and MРђ╝╬ИРЅАv', or more
  ---- specifically, out of the equality (T , v) РЅА (T , v') over TyVal

  РЂ║РЪеРЪЕр┤Йрхњ-­Ъъ░ :  ╬И РєдРЪе p РЪЕрхњ (-, v)  РѕЌрхњ  Pрхњ  Ріе  РЪе K р┤иРЌЂ VРЄњE v РЪЕр┤Йрхњ[ ╬╣ ]  Qрхњ╦Ў Рєњ
             ╬И РєдРЪе p РЪЕрхњ (-, v)  РѕЌрхњ  Pрхњ  Ріе  РЂ║РЪе ─ЕРѓЂ (K р┤и| ­Ъъ░р┤┐ ╬И) РЪЕр┤Йрхњ[ ╬╣ ]  Qрхњ╦Ў
  РЂ║РЪеРЪЕр┤Йрхњ-­Ъъ░ ╬ИРєдvРѕЌPРіеРЪеKvРЪЕQ ╬ИРєдvРѕЌPa =  РЂ║РЪеРЪЕр┤Йрхњ-kr ╬╗ M Рєњ ╬ИРєдvРѕЌPa Рќи РѕЌрхњ-mono╦А РєдРЪеРЪЕрхњ-read Рќи
    РЄЏрхњ-eat╩│ Рќи РЄЏрхњ-mono $ РѕЃрхњРѕЌрхњ-out Рђ║ ╬╗ (MРђ╝╬ИРЅАv , ╬ИРєдvРѕЌPb) Рєњ (-, redр┤ир┤┐ $ ­Ъъ░РЄњ MРђ╝╬ИРЅАv) ,
    ╬╗{ _ _ (redр┤ир┤┐ (­Ъъ░РЄњ MРђ╝╬ИРЅАv')) Рєњ РЌа MРђ╝╬ИРЅАv РЌЄ MРђ╝╬ИРЅАv' Рќи
    ╬╗{ refl Рєњ РЄЏрхњ-intro ╬╗{ .! Рєњ ╬ИРєдvРѕЌPРіеРЪеKvРЪЕQ ╬ИРєдvРѕЌPb }}}

  РЂ║РЪеРЪЕрхђрхњ-­Ъъ░ :  ╬И РєдРЪе p РЪЕрхњ (-, v)  РѕЌрхњ  Pрхњ  Ріе  РЪе K р┤иРЌЂ VРЄњE v РЪЕрхђрхњ[ ╬╣ ]  Qрхњ╦Ў Рєњ
             ╬И РєдРЪе p РЪЕрхњ (-, v)  РѕЌрхњ  Pрхњ  Ріе  РЂ║РЪе ─ЕРѓЂ (K р┤и| ­Ъъ░р┤┐ ╬И) РЪЕрхђрхњ[ Рѕъ ]  Qрхњ╦Ў
  РЂ║РЪеРЪЕрхђрхњ-­Ъъ░ ╬ИРєдvРѕЌPРіеРЪеKvРЪЕQ ╬ИРєдvРѕЌPa =  РЂ║РЪеРЪЕрхђрхњ-kr ╬╗ M Рєњ ╬ИРєдvРѕЌPa Рќи РѕЌрхњ-mono╦А РєдРЪеРЪЕрхњ-read Рќи
    РЄЏрхњ-eat╩│ Рќи РЄЏрхњ-mono $ РѕЃрхњРѕЌрхњ-out Рђ║ ╬╗ (MРђ╝╬ИРЅАv , ╬ИРєдvРѕЌPb) Рєњ (-, redр┤ир┤┐ $ ­Ъъ░РЄњ MРђ╝╬ИРЅАv) ,
    ╬╗{ _ _ (redр┤ир┤┐ (­Ъъ░РЄњ MРђ╝╬ИРЅАv')) Рєњ РЌа MРђ╝╬ИРЅАv РЌЄ MРђ╝╬ИРЅАv' Рќи
    ╬╗{ refl Рєњ РЄЏрхњ-intro $ ┬Д ╬ИРєдvРѕЌPРіеРЪеKvРЪЕQ ╬ИРєдvРѕЌPb }}

  -- Рєљ and РЂ║РЪеРЪЕр┤Йрхњ / РЂ║РЪеРЪЕрхђрхњ

  РЂ║РЪеРЪЕр┤Йрхњ-Рєљ :  ╬И Рєдрхњ (-, v)  РѕЌрхњ  Pрхњ  Ріе  РЪе K р┤иРЌЂ РѕЄ _ РЪЕр┤Йрхњ[ ╬╣ ]  Qрхњ╦Ў Рєњ
             ╬И Рєдрхњ (-, u)  РѕЌрхњ  Pрхњ  Ріе  РЂ║РЪе ─ЕРѓЂ (K р┤и| ╬И Рєљр┤┐ v) РЪЕр┤Йрхњ[ ╬╣ ]  Qрхњ╦Ў
  РЂ║РЪеРЪЕр┤Йрхњ-Рєљ ╬ИРєдvРѕЌPРіеРЪеKРѕЄРЪЕQ ╬ИРєдuРѕЌPa =  РЂ║РЪеРЪЕр┤Йрхњ-kr ╬╗ M Рєњ РЄЏрхњ-intro ((-, redр┤ир┤┐ РєљРЄњ) ,
    ╬╗{ _ _ (redр┤ир┤┐ РєљРЄњ) Рєњ ╬ИРєдuРѕЌPa Рќи РѕЌрхњ-mono╦А Рєдрхњ-write Рќи РЄЏрхњ-eat╩│ Рќи РЄЏрхњ-mono
    ╬╗ ╬ИРєдuРѕЌPb Рєњ ╬╗{ .! Рєњ ╬ИРєдvРѕЌPРіеРЪеKРѕЄРЪЕQ ╬ИРєдuРѕЌPb }})

  РЂ║РЪеРЪЕрхђрхњ-Рєљ :  ╬И Рєдрхњ (-, v)  РѕЌрхњ  Pрхњ  Ріе  РЪе K р┤иРЌЂ РѕЄ _ РЪЕрхђрхњ[ ╬╣ ]  Qрхњ╦Ў Рєњ
             ╬И Рєдрхњ (-, u)  РѕЌрхњ  Pрхњ  Ріе  РЂ║РЪе ─ЕРѓЂ (K р┤и| ╬И Рєљр┤┐ v) РЪЕрхђрхњ[ Рѕъ ]  Qрхњ╦Ў
  РЂ║РЪеРЪЕрхђрхњ-Рєљ ╬ИРєдvРѕЌPРіеРЪеKРЪЕQ ╬ИРєдuРѕЌPa =  РЂ║РЪеРЪЕрхђрхњ-kr ╬╗ M Рєњ РЄЏрхњ-intro ((-, redр┤ир┤┐ РєљРЄњ) ,
    ╬╗{ _ _ (redр┤ир┤┐ РєљРЄњ) Рєњ ╬ИРєдuРѕЌPa Рќи РѕЌрхњ-mono╦А Рєдрхњ-write Рќи РЄЏрхњ-eat╩│ Рќи РЄЏрхњ-mono
    ╬╗ ╬ИРєдuРѕЌPb Рєњ ┬Д ╬ИРєдvРѕЌPРіеРЪеKРЪЕQ ╬ИРєдuРѕЌPb })
